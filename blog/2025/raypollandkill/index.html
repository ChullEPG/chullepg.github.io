<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Ray Poll and Kill | Chris Hull </title> <meta name="author" content="Chris Hull"> <meta name="description" content="How to kill individual processes with Ray."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://chullepg.github.io/blog/2025/raypollandkill/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Chris</span> Hull </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Ray Poll and Kill</h1> <p class="post-meta"> Created in January 20, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/code"> <i class="fa-solid fa-hashtag fa-sm"></i> code</a>   ·   <a href="/blog/category/programming"> <i class="fa-solid fa-tag fa-sm"></i> programming</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Ray poll and kill allows a user to detect and terminate unresponsive task processes in a distributed environment without cancelling the entire script altogether. This is especially helpful in scenarios where some of your tasks might hang, crash, or get stuck in an infinite loop, potentially locking up all your workers and grinding your entire job to a halt.</p> <p>The essence of the approach is:</p> <ol> <li>Poll the set of running tasks at regular intervals (using ray.wait() with a short timeout).</li> <li>Identify any tasks that have exceeded a maximum expected run time.</li> <li>Cancel the stuck tasks one-by-one with ray.cancel(task_ref, force=True) instead of cancelling the entire job or waiting forever.</li> </ol> <p>Below is a reference script, followed by a more detailed motivation and explanation:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">ray</span>
<span class="kn">import</span> <span class="n">time</span> 
<span class="kn">import</span> <span class="n">multiprocessing</span>


<span class="c1"># Polling timeout (after which a task is considered 'stuck')
</span><span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">100</span> 

<span class="n">num_cpus</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nf">cpu_count</span><span class="p">()</span> <span class="o">//</span> <span class="mi">2</span> 
<span class="n">ray</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="n">num_cpus</span> <span class="o">=</span> <span class="n">num_cpus</span><span class="p">,</span> <span class="n">ignore_reinit_error</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>


<span class="c1"># Example ray task that sometimes hangs
</span><span class="nd">@ray.remote</span>
<span class="k">def</span> <span class="nf">maybe_hang</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> 
    <span class="sh">"""</span><span class="s"> A task that randomly sleeps or gets stuck.</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">random</span> 
    <span class="c1"># 20% chance of infinite loop
</span>    <span class="k">if</span> <span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.20</span><span class="p">:</span> 
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Task </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s"> completed in </span><span class="si">{</span><span class="n">sleep_time</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span>

<span class="c1"># Create references to tasks
</span><span class="n">task_refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">maybe_hang</span><span class="p">.</span><span class="nf">remote</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

<span class="c1"># Track when each task started
</span><span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">task_refs</span><span class="p">:</span>
    <span class="n">start_times</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> 


<span class="n">not_done</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">task_refs</span><span class="p">)</span>

<span class="c1"># Main polling loop: 
</span><span class="k">while</span> <span class="n">not_done</span><span class="p">:</span>  
    <span class="n">done</span><span class="p">,</span> <span class="n">not_done</span> <span class="o">=</span> <span class="n">ray</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="n">task_refs</span><span class="p">,</span> <span class="n">num_returns</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># If any tasks have completed, remove them from not_done 
</span>    <span class="k">for</span> <span class="n">task_ref</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
        <span class="c1"># Attempt to retrieve the result
</span>        <span class="k">try</span><span class="p">:</span> 
            <span class="n">ray</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">task_ref</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Task </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s"> failed with: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">not_done</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">task_ref</span><span class="p">)</span>


    <span class="c1"># Poll unfinished tasks
</span>    <span class="k">for</span> <span class="n">task_ref</span> <span class="ow">in</span> <span class="n">not_done</span><span class="p">:</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_times</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&gt;</span> <span class="n">TIMEOUT</span><span class="p">:</span> 
            <span class="n">to_cancel</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">task_ref</span><span class="p">)</span>

    <span class="c1"># Cancel tasks that exceeded TIMEOUT 
</span>    <span class="k">for</span> <span class="n">task_ref</span> <span class="ow">in</span> <span class="n">to_cancel</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Cancelling task </span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span> 
        <span class="n">ray</span><span class="p">.</span><span class="nf">cancel</span><span class="p">(</span><span class="n">task_ref</span><span class="p">)</span>
        <span class="n">futures</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">task_ref</span><span class="p">)</span>

<span class="n">ray</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">()</span>
</code></pre></div></div> <h4 id="how-it-works">How it works</h4> <p><strong>Motivation:</strong></p> <p>If workers get stuck and cannot free themselves, your script eventually runs out of free workers. Over time, tasks line up, and the script slows down – or grinds to a halt. The built-in solution, <code class="language-plaintext highlighter-rouge">ray.wait()</code>1, <em>will</em> let you see which tasks are “done”, but it does not necessarily kill unresponsive tasks that ignore polite termination signals.</p> <p><strong>SIGTERM vs SIGKILL</strong> \</p> <ul> <li>SIGTERM: Polite. It knocks on the door of a process and waits for it to acknowledge SIGTERMs presence. However, this can be too polite. If your code is in an infinite loop or a blocking system call, it might never get around to acknowledging SIGTERM, so you end up with a zombie worker. You will find these packages often lack built-in safeguards for interruption, i.e. they don’t stop to check for termination signals.</li> <li>SIGKILL: Aggressive. SIGTERM does not knock – it busts through the wall and terminates the process immediately, no chance for cleanup or final goodbyes. Some tasks might need <code class="language-plaintext highlighter-rouge">SIGKILL</code> if they are truly stuck in native C/C++ or certain system calls that ignore Python’s interrupt signals.</li> </ul> <p><code class="language-plaintext highlighter-rouge">ray.cancel(ref, force=True)</code> uses the more forceful approach. ensuring that if a subprocess is ignoring polite signals, it still gets reclaimed.</p> <p><strong><em>Tip</em>:</strong> <em>If you are running a long loop and not sure if processes are hanging or not, you can check if your system resources are being taken up by zombie processes using commands like<code class="language-plaintext highlighter-rouge">top</code> or <code class="language-plaintext highlighter-rouge">htop</code>.</em></p> <p>For me, the poll and kill strategy became useful when I distributed a task that runs <a href="https://gmsh.info" rel="external nofollow noopener" target="_blank">Gmsh</a> under the hood. Gmsh is written in C++ and crashed out in ~5% of tasks that I was running. Initially when running the script, I noticed that over time my script would slow down, eventually grinding to a halt when all of the workers had taken up one by one.</p> <p>Ray’s poll-and-kill technique provides fine-grained control over long-running or potentially stuck tasks, letting you forcibly remove outliers without taking down the entire job. By combining <code class="language-plaintext highlighter-rouge">ray.wait()</code> with an appropriate timeout and invoking <code class="language-plaintext highlighter-rouge">ray.cancel(ref, force=True)</code>, you can keep your Ray clusters running smoothly—even under the unpredictable conditions often encountered in distributed computing.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Chris Hull. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?70d799092f862ad98c7876aa47712e20"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> <script defer src="/assets/js/newsletter.js?c3d0931971ee96e9df74ba70526c3130"></script> </body> </html>